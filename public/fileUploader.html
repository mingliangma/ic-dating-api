<!DOCTYPE html>
<html>
<head>
    <title>Limitless Image Upload</title>
</head>
<body>
<h1>Welcome!</h1>
<br>Please select an image
<input type="file" id="image">
<br>
<img id="preview">

<script>

  function upload(file, signed_request, url, done) {

    console.log('signed_request: ',signed_request)

    var xhr = createCORSRequest('PUT', signed_request);
    if (!xhr) {
      alert('CORS not supported');
      return;
    }
    xhr.onload = function() {
      if (xhr.status === 200) {
        done()
      }
    }

    xhr.onerror = function() {
      alert('Woops, there was an error making the request.');
    };

    xhr.send(file)
  }

  function sign_request(file, done) {
    var xhr = new XMLHttpRequest()
    xhr.open("GET", "/api/v1/account/12345/image/upload?file_name=" + file.name + "&file_type=" + file.type)

    xhr.onreadystatechange = function() {
      if(xhr.readyState === 4 && xhr.status === 200) {
        var response = JSON.parse(xhr.responseText)
        done(response)
      }
    }

    xhr.send()
  }

  function createCORSRequest(method, url) {
    var xhr = new XMLHttpRequest();
    if ("withCredentials" in xhr) {
      // XHR for Chrome/Firefox/Opera/Safari.
      xhr.open(method, url, true);
    } else if (typeof XDomainRequest != "undefined") {
      // XDomainRequest for IE.
      xhr = new XDomainRequest();
      xhr.open(method, url);
    } else {
      // CORS not supported.
      xhr = null;
    }
    return xhr;
  }

  document.getElementById("image").onchange = function() {
    var file = document.getElementById("image").files[0]
    if (!file) return

    sign_request(file, function(response) {
      upload(file, response.signed_request, response.url, function() {
        document.getElementById("preview").src = response.url
      })
    })
  }
</script>
</body>
</html>